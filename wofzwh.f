C      SUBROUTINE WEIDEMAN(XI, YI, U, V, FLAG)
C  GIVEN A COMPLEX NUMBER Z = (XI,YI), THIS SUBROUTINE COMPUTES
C  THE VALUE OF THE FADDEEVA-FUNCTION W(Z) = EXP(-Z**2)*ERFC(-I*Z),
C  WHERE ERFC IS THE COMPLEX COMPLEMENTARY ERROR-FUNCTION AND I
C  MEANS SQRT(-1).THE ALGORITHM IS BASED ON THE PAPER PUBLISHED ON
C  SIAM JOURNAL ON NUMERICAL ANALYSIS VOL.31 NO.5 PP.1497-1518,OCTOBER
C  1994 BY J.A.C. WEIDEMAN.THE USER CAN CHOOSE BETWEEN N=4, N=8 AND N=16.
      SUBROUTINE WOFZWH(XI,YI,U,V,FLAG)
C      IMPLICIT DOUBLE PRECISION (A-H, O-Z)
      IMPLICIT NONE
      INTRINSIC SQRT, REAL, AIMAG, DABS
      EXTERNAL RPOLYEV
      DOUBLE PRECISION CFFT(16), L, XABS, YABS,
     * SR, SI, QR(16), QI(16), PVR, PVI, XABSQ, XQUAD, YQUAD,
     * XI,YI,U,V,FACTOR,PI
      INTEGER N
      PARAMETER (FACTOR   = 1.12837916709551257388D0, 
     *     PI = 3.141592653589793)
      LOGICAL FLAG
      DOUBLE COMPLEX Z1, i, Z2, A, B, C, P, W
C     THE N COEFFICIENTS OF FAST FOURIER TRANSFORM
C     COEFFICIENTS TO USE FOR N=4
C      DATA CFFT(1) / -0.036387778131343 /
C      DATA CFFT(2) / -0.009515238439985 /
C      DATA CFFT(3) / 0.263633942774273 /
C      DATA CFFT(4) / 0.715253452379754 /
C     COEFFICIENTS TO USE FOR N=8
C      DATA CFFT(1) / 0.001422984804155 /
C      DATA CFFT(2) / 0.001514258764391 /
C      DATA CFFT(3) / -0.008825132847676 /
C      DATA CFFT(4) / -0.017753679350031 /
C      DATA CFFT(5) / 0.044594093387920 /
C      DATA CFFT(6) / 0.280930761779060 /
C      DATA CFFT(7) / 0.706286816137253 /
C      DATA CFFT(8) / 1.149736350667053 /
C     COEFFICIENTS TO USE FOR N=16
      DATA CFFT(1) / 9.939322535568174e-07 /
      DATA CFFT(2) / 3.981287575088865e-06 /
      DATA CFFT(3) / -5.584233411098927e-06 /
      DATA CFFT(4) / -2.734640462448423e-05 /
      DATA CFFT(5) / 2.170986793223473e-05 /
      DATA CFFT(6) / 2.107105639653287e-04 /
      DATA CFFT(7) / 8.703158428458035e-05 /
      DATA CFFT(8) / -0.001527659740122 /
      DATA CFFT(9) / -0.003881015189023 /
      DATA CFFT(10) / 0.003682567317092 /
      DATA CFFT(11) / 0.051822402431612 /
      DATA CFFT(12) / 0.191241726746695 /
      DATA CFFT(13) / 0.469290900903604 /
      DATA CFFT(14) / 0.886447830205055 /
      DATA CFFT(15) / 1.362240822271959 /
      DATA CFFT(16) / 1.748395886081962 /
      FLAG = .FALSE.
      i = CMPLX(0,1)
      N = 16
      L = 2**(-0.25)*DSQRT(N*1.0d0)

      Z1=XI+i*YI
c      WRITE (*,*) Z1


      IF (YI.LT.0) THEN
         Z1=-Z1
      ENDIF
         Z2 = (L+i*Z1)/(L-i*Z1)
         A = (1/DSQRT(PI))/(L-i*Z1)
         B = 2/((L-i*Z1)**2)
         C = 0.0
      SR = DBLE(Z2)
      SI = DIMAG(Z2)
      CALL RPOLYEV(N,SR,SI,CFFT,QR,QI,PVR,PVI)
      P = CMPLX(PVR,PVI)
      Z2 = A+B*P+C
      IF (YI.LT.0) THEN
         Z2=-Z2
      ENDIF
      U = DBLE(Z2)
      V = DIMAG(Z2)
      RETURN
  100 FLAG = .TRUE.
      RETURN
*
      END
